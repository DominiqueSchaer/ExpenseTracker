<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mila Expense Tracker</title>

  <!-- Update this to your backend URL in production , http://localhost:8000 vs https://fastapi-app.wittysand-ac101e81.westeurope.azurecontainerapps.io -->
  <meta name="api-base" content="https://fastapi-app.wittysand-ac101e81.westeurope.azurecontainerapps.io">

  <link href="static/output.css" rel="stylesheet" />
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-gradient-to-b from-slate-50 to-white min-h-screen text-slate-800">
  <!-- Top bar -->
  <header class="border-b bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-9 rounded-2xl bg-blue-600/10 grid place-items-center">
          <span class="text-blue-700 font-semibold">M</span>
        </div>
        <div>
          <h1 class="text-lg sm:text-xl font-semibold tracking-tight">Mila Expense Tracker</h1>
          <p class="text-xs text-slate-500">Family Dashboard</p>
        </div>
      </div>
      <button id="refreshBtn"
              class="text-sm px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50 active:bg-slate-100 transition">
        Refresh
      </button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 sm:p-6">

    <!-- ===== Summary row (NEW) ===== -->
    <section id="summaryContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mb-6">
      <!-- skeleton -->
      <div class="rounded-2xl border bg-white/80 p-4">
        <div class="text-xs text-slate-500">Total</div>
        <div class="mt-1 h-6 bg-slate-100 rounded"></div>
      </div>
      <div class="rounded-2xl border bg-white/80 p-4">
        <div class="text-xs text-slate-500">Pending</div>
        <div class="mt-1 h-6 bg-slate-100 rounded"></div>
      </div>
      <div class="rounded-2xl border bg-white/80 p-4">
        <div class="text-xs text-slate-500">Approved</div>
        <div class="mt-1 h-6 bg-slate-100 rounded"></div>
      </div>
      <div class="rounded-2xl border bg-white/80 p-4">
        <div class="text-xs text-slate-500">Reimbursed</div>
        <div class="mt-1 h-6 bg-slate-100 rounded"></div>
      </div>
    </section>

    <section class="grid lg:grid-cols-2 gap-6">
      <!-- Expenses list -->
      <div class="rounded-3xl border bg-white shadow-sm">
        <div class="px-5 py-4 border-b">
          <h2 class="text-base sm:text-lg font-medium">Expenses</h2>
        </div>
        <div id="expensesContainer" class="p-4 sm:p-5 space-y-3">
          <div class="text-sm text-slate-500">Loading…</div>
        </div>
      </div>

      <!-- Forms: add + reimburse -->
      <div class="rounded-3xl border bg-white shadow-sm">
        <div class="px-5 py-4 border-b">
          <h2 class="text-base sm:text-lg font-medium">Actions</h2>
        </div>

        <div class="p-4 sm:p-5 space-y-8">
          <!-- Add -->
          <div>
            <h3 class="text-sm font-semibold text-slate-700 mb-3">Add Expense</h3>
            <form id="addForm" class="space-y-3">
              <!-- default date set via JS -->
              <input name="date" id="dateInput" type="date" required
                     class="w-full rounded-xl border px-3 py-2.5 text-sm outline-none focus:ring-2 ring-blue-600/20 focus:border-blue-600" />
              <input name="description" type="text" placeholder="Description" required
                     class="w-full rounded-xl border px-3 py-2.5 text-sm outline-none focus:ring-2 ring-blue-600/20 focus:border-blue-600" />
              <input name="amount" type="number" step="0.01" placeholder="Amount" required
                     class="w-full rounded-xl border px-3 py-2.5 text-sm outline-none focus:ring-2 ring-blue-600/20 focus:border-blue-600" />
              <div class="flex gap-2">
                <button type="submit"
                        class="inline-flex items-center gap-1.5 rounded-xl bg-blue-600 text-white px-4 py-2.5 text-sm font-medium shadow-sm hover:bg-blue-700 active:bg-blue-800 transition">
                  Add
                </button>
                <button type="button" id="clearForm"
                        class="inline-flex items-center gap-1.5 rounded-xl border px-4 py-2.5 text-sm hover:bg-slate-50 active:bg-slate-100 transition">
                  Clear
                </button>
              </div>
              <div id="addMessage" class="text-sm mt-1 h-5"></div>
            </form>
          </div>

          <!-- Reimburse -->
          <div>
            <h3 class="text-sm font-semibold text-slate-700 mb-3">Reimburse</h3>
            <form id="reimburseForm" class="flex gap-2">
              <input name="amount" type="number" step="0.01" placeholder="Amount" required
                     class="flex-1 rounded-xl border px-3 py-2.5 text-sm outline-none focus:ring-2 ring-green-600/20 focus:border-green-600" />
              <button type="submit"
                      class="rounded-xl bg-green-600 text-white px-4 py-2.5 text-sm font-medium shadow-sm hover:bg-green-700 active:bg-green-800 transition">
                Reimburse
              </button>
            </form>
            <div id="reimburseMessage" class="text-sm mt-2 h-5"></div>
          </div>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-xs text-slate-500 text-center">
      App in a day by Chnüppi
    </footer>
  </main>

  <script>
    // ===== Utilities =====
    const apiBase = document.querySelector('meta[name="api-base"]').content.replace(/\/$/, '');
    const EUR = (n) => `${Number(n || 0).toFixed(2)} €`;
    const todayISO = () => new Date().toISOString().slice(0, 10);

    async function api(path, opts = {}) {
      const res = await fetch(apiBase + path, {
        headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) },
        ...opts,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(res.status + ' ' + text);
      }
      return res.json();
    }

    // ===== Summary (NEW) =====
    function computeSummary(items) {
      const sum = (arr) => arr.reduce((a, b) => a + Number(b.amount || 0), 0);
      const byStatus = {
        pending: items.filter(x => x.status === 'pending'),
        approved: items.filter(x => x.status === 'approved'),
        reimbursed: items.filter(x => x.status === 'reimbursed'),
      };
      return {
        total: sum(items),
        pending: { count: byStatus.pending.length, amount: sum(byStatus.pending) },
        approved: { count: byStatus.approved.length, amount: sum(byStatus.approved) },
        reimbursed: { count: byStatus.reimbursed.length, amount: sum(byStatus.reimbursed) },
      };
    }

    function renderSummary(s) {
      const card = (label, value, sub, color) => `
        <div class="rounded-2xl border bg-white/80 p-4">
          <div class="text-xs text-slate-500">${label}</div>
          <div class="mt-1 text-lg font-semibold ${color} tabular-nums">${value}</div>
          ${sub ? `<div class="text-xs text-slate-500 mt-0.5">${sub}</div>` : ''}
        </div>
      `;
      return [
        card('Total', EUR(s.total), ''),
        card('Pending', EUR(s.pending.amount), `${s.pending.count} item(s)`, 'text-amber-700'),
        card('Approved', EUR(s.approved.amount), `${s.approved.count} item(s)`, 'text-blue-700'),
        card('Reimbursed', EUR(s.reimbursed.amount), `${s.reimbursed.count} item(s)`, 'text-green-700'),
      ].join('');
    }

    function updateSummary(items) {
      const s = computeSummary(items);
      document.getElementById('summaryContainer').innerHTML = renderSummary(s);
    }

    // ===== Expenses =====
    function renderExpenseItem(exp) {
      const statusBadge =
        exp.status === 'approved'
          ? '<span class="text-amber-800 bg-amber-100 px-2 py-0.5 rounded-full text-xs">Approved</span>'
          : exp.status === 'reimbursed'
          ? '<span class="text-green-800 bg-green-100 px-2 py-0.5 rounded-full text-xs">Reimbursed</span>'
          : '<span class="text-slate-700 bg-slate-100 px-2 py-0.5 rounded-full text-xs">Pending</span>';

      const approveBtn =
        exp.status === 'pending'
          ? `<button data-id="${exp.id}" class="approveBtn rounded-lg bg-blue-600 text-white px-3 py-1.5 text-xs font-medium shadow-sm hover:bg-blue-700 active:bg-blue-800 transition">Approve</button>`
          : '';

      return `
        <div class="rounded-2xl border p-4 sm:p-5 bg-white/80 backdrop-blur shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <div class="font-medium truncate">${escapeHtml(exp.description)}</div>
                ${statusBadge}
              </div>
              <div class="text-xs text-slate-500 mt-1">By: ${escapeHtml(exp.submittedBy || 'Mila')} • ${escapeHtml(exp.date)}</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-semibold tabular-nums">${EUR(exp.amount)}</div>
              <div class="mt-2">${approveBtn}</div>
            </div>
          </div>
        </div>
      `;
    }

    function escapeHtml(s) {
      if (s === undefined || s === null) return '';
      return String(s).replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    async function loadExpenses() {
      const container = document.getElementById('expensesContainer');
      container.innerHTML = '<div class="text-sm text-slate-500">Loading…</div>';
      try {
        const data = await api('/api/expenses');
        // --- Summary update (NEW) ---
        updateSummary(Array.isArray(data) ? data : []);
        // --- List rendering ---
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<div class="text-sm text-slate-500">No expenses yet.</div>';
          return;
        }
        container.innerHTML = data.map(renderExpenseItem).join('');
        document.querySelectorAll('.approveBtn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            e.currentTarget.disabled = true;
            try {
              await api(`/api/expenses/${id}/approve`, { method: 'POST' });
              await loadExpenses();
            } catch (err) {
              alert('Approve failed: ' + err.message);
              e.currentTarget.disabled = false;
            }
          });
        });
      } catch (err) {
        container.innerHTML = `<div class="text-sm text-red-600">Error: ${escapeHtml(err.message)}</div>`;
        // keep whatever summary was shown before
      }
    }

    // ===== Forms =====
    document.getElementById('addForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const form = ev.target;
      const data = {
        date: form.date.value,
        description: form.description.value,
        amount: parseFloat(form.amount.value),
      };
      const msg = document.getElementById('addMessage');
      msg.textContent = 'Adding…';
      msg.classList.remove('text-red-600');
      try {
        await api('/api/expenses', { method: 'POST', body: JSON.stringify(data) });
        msg.textContent = 'Added.';
        form.reset();
        // keep the date default to today after reset
        document.getElementById('dateInput').value = todayISO();
        await loadExpenses();
      } catch (err) {
        msg.textContent = 'Error: ' + err.message;
        msg.classList.add('text-red-600');
      }
      setTimeout(() => { msg.textContent = ''; msg.classList.remove('text-red-600'); }, 3000);
    });

    document.getElementById('clearForm').addEventListener('click', () => {
      const form = document.getElementById('addForm');
      form.reset();
      document.getElementById('dateInput').value = todayISO(); // restore today
    });

    document.getElementById('reimburseForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const form = ev.target;
      const amount = parseFloat(form.amount.value);
      const msg = document.getElementById('reimburseMessage');
      msg.textContent = 'Processing…';
      msg.classList.remove('text-red-600');
      try {
        const res = await api('/api/reimburse', { method: 'POST', body: JSON.stringify({ amount }) });
        msg.textContent = `Remaining: ${EUR(res.remaining)}`;
        form.reset();
        await loadExpenses();
      } catch (err) {
        msg.textContent = 'Error: ' + err.message;
        msg.classList.add('text-red-600');
      }
      setTimeout(() => { msg.textContent = ''; msg.classList.remove('text-red-600'); }, 5000);
    });

    // refresh button
    document.getElementById('refreshBtn').addEventListener('click', loadExpenses);

    // ===== init =====
    window.addEventListener('DOMContentLoaded', () => {
      // Set default date to today
      const dateEl = document.getElementById('dateInput');
      if (dateEl && !dateEl.value) dateEl.value = todayISO();
      // Load data
      loadExpenses();
    });
  </script>
</body>
</html>
